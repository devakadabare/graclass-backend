// Online Lecturer Management System - Database Schema
// This schema defines the complete database structure for managing
// lecturers, students, courses, classes, and related entities

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ================================
// ENUMS
// ================================

enum UserRole {
  ADMIN
  LECTURER
  STUDENT
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ClassType {
  VISITING
  ONLINE
}

enum ClassStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
}

// ================================
// USER & AUTHENTICATION
// ================================

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  password        String
  role            UserRole @default(STUDENT)
  isActive        Boolean  @default(true)
  isEmailVerified Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  lecturer Lecturer?
  student  Student?

  @@index([email])
  @@index([role])
  @@map("users")
}

// ================================
// LECTURER MODULE
// ================================

model Lecturer {
  id             String   @id @default(uuid())
  userId         String   @unique
  firstName      String
  lastName       String
  phone          String?
  bio            String?  @db.Text
  qualifications String?  @db.Text
  profilePicture String?
  profileImage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses        Course[]
  classes        Class[]
  availabilities Availability[]
  contents       Content[]

  @@index([userId])
  @@map("lecturers")
}

model Availability {
  id           String    @id @default(uuid())
  lecturerId   String
  dayOfWeek    Int? // 0-6 (Sunday-Saturday) for recurring
  specificDate DateTime? @db.Date // For one-time availability
  startTime    String // HH:mm format
  endTime      String // HH:mm format
  isRecurring  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  lecturer Lecturer @relation(fields: [lecturerId], references: [id], onDelete: Cascade)

  @@index([lecturerId])
  @@index([dayOfWeek])
  @@index([specificDate])
  @@map("availabilities")
}

// ================================
// STUDENT MODULE
// ================================

model Student {
  id             String   @id @default(uuid())
  userId         String   @unique
  firstName      String
  lastName       String
  phone          String?
  university     String?
  studentId      String?
  profilePicture String?
  profileImage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseEnrollments     CourseEnrollment[]
  groupEnrollments      GroupEnrollment[]
  individualClasses     Class[]            @relation("IndividualStudentClasses")
  createdGroups         StudentGroup[]     @relation("GroupCreator")
  lecturerRegistrations LecturerStudent[]

  @@index([userId])
  @@map("students")
}

model StudentGroup {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  createdBy   String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  creator       Student            @relation("GroupCreator", fields: [createdBy], references: [id])
  enrollments   GroupEnrollment[]
  classes       Class[]            @relation("GroupClasses")
  courseEnrolls CourseEnrollment[]

  @@index([createdBy])
  @@index([isActive])
  @@map("student_groups")
}

model GroupEnrollment {
  id        String           @id @default(uuid())
  studentId String
  groupId   String
  status    EnrollmentStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  student Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group   StudentGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId])
  @@index([studentId])
  @@index([groupId])
  @@index([status])
  @@map("group_enrollments")
}

// ================================
// COURSE MODULE
// ================================

model Course {
  id          String   @id @default(uuid())
  lecturerId  String
  name        String
  description String?  @db.Text
  subject     String
  level       String?
  duration    Int // Duration in minutes
  hourlyRate  Decimal  @db.Decimal(10, 2)
  flyer       String? // S3 URL for course flyer/banner image
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lecturer    Lecturer           @relation(fields: [lecturerId], references: [id], onDelete: Cascade)
  classes     Class[]
  enrollments CourseEnrollment[]
  contents    Content[]
  images      CourseImage[]

  @@index([lecturerId])
  @@index([isActive])
  @@index([subject])
  @@map("courses")
}

model CourseImage {
  id        String   @id @default(uuid())
  courseId  String
  imageUrl  String // S3 URL for the image
  order     Int      @default(0) // Display order
  createdAt DateTime @default(now())

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@map("course_images")
}

model CourseEnrollment {
  id             String           @id @default(uuid())
  courseId       String
  studentId      String?
  studentGroupId String?
  status         EnrollmentStatus @default(PENDING)
  requestedAt    DateTime         @default(now())
  approvedAt     DateTime?
  rejectedAt     DateTime?

  // Relations
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student      Student?      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentGroup StudentGroup? @relation(fields: [studentGroupId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId])
  @@unique([courseId, studentGroupId])
  @@index([courseId])
  @@index([studentId])
  @@index([studentGroupId])
  @@index([status])
  @@map("course_enrollments")
}

// ================================
// CLASS/SESSION MODULE
// ================================

model Class {
  id             String      @id @default(uuid())
  courseId       String
  lecturerId     String
  studentId      String?
  studentGroupId String?
  date           DateTime    @db.Date
  startTime      String // HH:mm format
  endTime        String // HH:mm format
  type           ClassType   @default(VISITING)
  status         ClassStatus @default(SCHEDULED)
  location       String?
  meetingLink    String?
  notes          String?     @db.Text
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lecturer     Lecturer      @relation(fields: [lecturerId], references: [id], onDelete: Cascade)
  student      Student?      @relation("IndividualStudentClasses", fields: [studentId], references: [id], onDelete: Cascade)
  studentGroup StudentGroup? @relation("GroupClasses", fields: [studentGroupId], references: [id], onDelete: Cascade)
  payment      Payment?

  @@index([courseId])
  @@index([lecturerId])
  @@index([studentId])
  @@index([studentGroupId])
  @@index([date])
  @@index([status])
  @@map("classes")
}

// ================================
// PAYMENT MODULE
// ================================

model Payment {
  id            String        @id @default(uuid())
  classId       String        @unique
  amount        Decimal       @db.Decimal(10, 2)
  status        PaymentStatus @default(PENDING)
  dueDate       DateTime      @db.Date
  paidAt        DateTime?
  paymentMethod String?
  transactionId String?
  notes         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([status])
  @@index([dueDate])
  @@map("payments")
}

// ================================
// CONTENT MODULE
// ================================

model Content {
  id          String   @id @default(uuid())
  courseId    String
  lecturerId  String
  title       String
  description String?  @db.Text
  fileUrl     String
  fileType    String
  fileSize    Int? // Size in bytes
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lecturer Lecturer @relation(fields: [lecturerId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([lecturerId])
  @@map("contents")
}

// ================================
// LECTURER-STUDENT REGISTRATION
// ================================

model LecturerStudent {
  id         String   @id @default(uuid())
  lecturerId String
  studentId  String
  createdAt  DateTime @default(now())

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([lecturerId, studentId])
  @@index([lecturerId])
  @@index([studentId])
  @@map("lecturer_students")
}
